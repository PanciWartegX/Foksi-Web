<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - FOKSI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-clipboard-check"></i>
                    <h2>Admin FOKSI</h2>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-details">
                        <h3 id="adminName">Admin Name</h3>
                        <p id="adminRole">Administrator</p>
                    </div>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="admin-dashboard.html" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="tambah-akun.html" class="nav-item">
                    <i class="fas fa-user-plus"></i>
                    <span>Tambah Akun</span>
                </a>
                <a href="pengaturan-absensi.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan Absensi</span>
                </a>
                <a href="data-absensi.html" class="nav-item">
                    <i class="fas fa-database"></i>
                    <span>Data Absensi</span>
                </a>
            </div>
            
            <div class="logout-btn">
                <a href="#" onclick="logout()" class="nav-item">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1>Dashboard Admin</h1>
                <div class="header-actions">
                    <span id="currentDateTime"></span>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-users"></i>
                        <span class="stat-label">Total Anggota</span>
                    </div>
                    <div class="stat-value" id="totalAnggota">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-check-circle"></i>
                        <span class="stat-label">Hadir Hari Ini</span>
                    </div>
                    <div class="stat-value" id="hadirHariIni">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-clock"></i>
                        <span class="stat-label">Status Absensi</span>
                    </div>
                    <div class="stat-value" id="statusAbsensi">Mati</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="stat-label">Kegiatan</span>
                    </div>
                    <div class="stat-value" id="namaKegiatan">-</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="content-card">
                <div class="card-header">
                    <h2>Quick Actions</h2>
                </div>
                <div class="actions-grid">
                    <div class="action-item" onclick="window.location.href='tambah-akun.html'">
                        <i class="fas fa-user-plus"></i>
                        <h3>Tambah Anggota</h3>
                        <p>Daftarkan anggota baru</p>
                    </div>
                    <div class="action-item" onclick="window.location.href='pengaturan-absensi.html'">
                        <i class="fas fa-calendar-plus"></i>
                        <h3>Atur Absensi</h3>
                        <p>Atur jadwal absensi</p>
                    </div>
                    <div class="action-item" onclick="window.location.href='data-absensi.html'">
                        <i class="fas fa-file-export"></i>
                        <h3>Export Data</h3>
                        <p>Export ke Excel</p>
                    </div>
                    <div class="action-item" onclick="lihatSemuaAbsensi()">
                        <i class="fas fa-chart-bar"></i>
                        <h3>Statistik</h3>
                        <p>Lihat laporan</p>
                    </div>
                </div>
            </div>

            <!-- Recent Absensi -->
            <div class="content-card">
                <div class="card-header">
                    <h2>Absensi Terbaru</h2>
                    <button class="btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <div class="table-container">
                    <table id="recentAbsensiTable">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Jabatan</th>
                                <th>Regional</th>
                                <th>Status</th>
                                <th>Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="absensiTableBody">
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { checkAuth, logoutUser } from './auth.js';
        import { db } from './firebase-config.js';
        import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
        
        // Global variables
        let currentUser = null;
        
        // Check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log("Admin Dashboard - Loading...");
                
                currentUser = checkAuth();
                console.log("User from checkAuth:", currentUser);
                
                if (!currentUser) {
                    console.log("No user found, redirecting to login");
                    window.location.href = 'index.html';
                    return;
                }
                
                if (currentUser.role !== 'admin') {
                    console.log("User is not admin, redirecting to member dashboard");
                    window.location.href = 'anggota-dashboard.html';
                    return;
                }
                
                // Set user info
                document.getElementById('adminName').textContent = currentUser.nama || 'Admin';
                document.getElementById('adminRole').textContent = currentUser.role;
                document.getElementById('adminAvatar').textContent = currentUser.nama ? currentUser.nama.charAt(0).toUpperCase() : 'A';
                
                // Update date time
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // Load dashboard data
                await loadDashboardData();
                
            } catch (error) {
                console.error("Initialization error:", error);
                window.location.href = 'index.html';
            }
        });
        
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeStr = now.toLocaleDateString('id-ID', options);
            document.getElementById('currentDateTime').textContent = dateTimeStr;
        }
        
        // Load data
        async function loadDashboardData() {
            try {
                console.log("Loading dashboard data...");
                
                // Load total anggota
                const usersSnapshot = await getDocs(collection(db, "users"));
                let totalAnggota = 0;
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.role === 'anggota') {
                        totalAnggota++;
                    }
                });
                
                console.log("Total anggota:", totalAnggota);
                document.getElementById('totalAnggota').textContent = totalAnggota;
                
                // Load settings
                const settingsDoc = await getDoc(doc(db, "settings", "absensi"));
                if (settingsDoc.exists()) {
                    const settings = settingsDoc.data();
                    console.log("Settings loaded:", settings);
                    
                    document.getElementById('namaKegiatan').textContent = settings.nama_kegiatan || '-';
                    
                    // Check absensi status
                    const isOpen = checkAbsensiStatus(settings);
                    document.getElementById('statusAbsensi').textContent = isOpen ? 'Aktif' : 'Mati';
                    document.getElementById('statusAbsensi').style.color = isOpen ? 'var(--success-color)' : 'var(--danger-color)';
                } else {
                    console.log("No settings found");
                    document.getElementById('namaKegiatan').textContent = '-';
                    document.getElementById('statusAbsensi').textContent = 'Mati';
                    document.getElementById('statusAbsensi').style.color = 'var(--danger-color)';
                }
                
                // Load recent absensi
                await loadRecentAbsensi();
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showError("Gagal memuat data: " + error.message);
            }
        }
        
        function checkAbsensiStatus(settings) {
            if (!settings) return false;
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            if (settings.tanggal !== today) return false;
            
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const openTime = timeToMinutes(settings.jam_buka);
            const closeTime = timeToMinutes(settings.jam_tutup);
            
            return currentTime >= openTime && currentTime <= closeTime;
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        async function loadRecentAbsensi() {
            try {
                console.log("Loading recent absensi...");
                const absensiSnapshot = await getDocs(collection(db, "absensi"));
                const tbody = document.getElementById('absensiTableBody');
                tbody.innerHTML = '';
                
                // Sort by timestamp descending and take latest 10
                const absensiList = [];
                absensiSnapshot.forEach(doc => {
                    const data = doc.data();
                    absensiList.push({ 
                        id: doc.id, 
                        ...data,
                        timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : data.timestamp
                    });
                });
                
                // Sort by timestamp descending
                absensiList.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA;
                });
                
                const recentAbsensi = absensiList.slice(0, 10);
                
                if (recentAbsensi.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>Belum ada data absensi</p>
                            </td>
                        </tr>
                    `;
                } else {
                    recentAbsensi.forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.nama || '-'}</td>
                            <td>${record.jabatan || '-'}</td>
                            <td>${record.regional || '-'}</td>
                            <td><span class="status-badge status-${record.status?.toLowerCase() || 'alpa'}">${getStatusText(record.status)}</span></td>
                            <td>${formatTime(record.timestamp)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                // Update hadir hari ini count
                const today = new Date().toISOString().split('T')[0];
                let hadirHariIni = 0;
                absensiList.forEach(record => {
                    if (record.tanggal === today && record.status === 'H') {
                        hadirHariIni++;
                    }
                });
                
                console.log("Hadir hari ini:", hadirHariIni);
                document.getElementById('hadirHariIni').textContent = hadirHariIni;
                
            } catch (error) {
                console.error("Error loading recent absensi:", error);
                const tbody = document.getElementById('absensiTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="error-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Gagal memuat data absensi</p>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'H': 'Hadir',
                'I': 'Izin',
                'S': 'Sakit',
                'A': 'Alpa'
            };
            return statusMap[status] || status || '-';
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
                return date.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            } catch (error) {
                return '-';
            }
        }
        
        function refreshData() {
            console.log("Refreshing data...");
            loadDashboardData();
        }
        
        function lihatSemuaAbsensi() {
            window.location.href = 'data-absensi.html';
        }
        
        function showError(message) {
            // Create error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;
            
            // Insert at the top of main content
            const mainContent = document.querySelector('.main-content');
            const header = document.querySelector('.header');
            mainContent.insertBefore(alertDiv, header.nextSibling);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        function logout() {
            logoutUser();
        }
    </script>
    
    <style>
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .action-item {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .action-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }
        
        .action-item i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .action-item h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }
        
        .action-item p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</body>
</html>